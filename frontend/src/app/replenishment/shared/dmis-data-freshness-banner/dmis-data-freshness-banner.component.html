@if (shouldRender) {
  <div
    class="freshness-banner"
  [ngClass]="{
    'banner-critical': isCritical,
    'banner-warning': isWarning,
    'banner-fresh': isFresh
  }"
    role="alert"
    [attr.aria-label]="getBannerMessage()">
    <!-- Refresh progress bar -->
    @if (isRefreshing) {
      <mat-progress-bar
        mode="indeterminate"
        class="refresh-progress">
      </mat-progress-bar>
    }
    <!-- Main banner row -->
    <div
      class="banner-main"
      role="button"
      tabindex="0"
      [attr.aria-expanded]="isExpanded"
      aria-controls="freshnessDetailsPanel"
      (click)="toggleExpanded()"
      (keydown.enter)="toggleExpanded()"
      (keydown.space)="toggleExpanded(); $event.preventDefault()">
      <div class="banner-left">
        <mat-icon class="banner-icon">{{ getBannerIcon() }}</mat-icon>
        <span class="banner-message">{{ getBannerMessage() }}</span>
        <button
          mat-button
          class="details-btn"
          (click)="toggleExpanded(); $event.stopPropagation()">
          {{ isExpanded ? 'Hide Details' : 'View Details' }}
        </button>
      </div>
      <div class="banner-actions">
        @if (bannerState?.lastSuccessfulSync) {
          <span class="last-sync">
            Last sync: {{ bannerState!.lastSuccessfulSync! | date:'short' }}
          </span>
        }
        <button
          mat-stroked-button
          class="refresh-btn"
          (click)="refreshData(); $event.stopPropagation()"
          [disabled]="isRefreshing"
          matTooltip="Trigger a fresh data sync from all warehouses">
          <mat-icon>refresh</mat-icon>
          Refresh Data
        </button>
        <button
          mat-icon-button
          class="expand-btn"
          (click)="toggleExpanded(); $event.stopPropagation()"
          [matTooltip]="isExpanded ? 'Hide details' : 'Show warehouse details'">
          <mat-icon>{{ isExpanded ? 'expand_less' : 'expand_more' }}</mat-icon>
        </button>
      </div>
    </div>
    <!-- Expanded per-warehouse detail table -->
    @if (isExpanded) {
      <div class="banner-detail" id="freshnessDetailsPanel">
        <table class="freshness-table" aria-label="Per-warehouse data freshness">
          <thead>
            <tr>
              <th>Warehouse</th>
              <th>Status</th>
              <th>Data Age</th>
              <th>Last Sync</th>
            </tr>
          </thead>
          <tbody>
            @for (wh of bannerState?.warehouses; track wh) {
              <tr
                [ngClass]="'row-freshness-' + wh.freshness.toLowerCase()">
                <td class="col-warehouse">
                  <mat-icon class="wh-icon">warehouse</mat-icon>
                  {{ wh.warehouse_name }}
                </td>
                <td>
                  <span class="status-badge" [ngClass]="'badge-freshness-' + wh.freshness.toLowerCase()">
                    <mat-icon class="status-icon">{{ getFreshnessIcon(wh.freshness) }}</mat-icon>
                    {{ wh.freshness }}
                  </span>
                </td>
                <td>{{ formatAgeHours(wh.age_hours) }}</td>
                <td>{{ wh.last_sync ? (wh.last_sync | date:'short') : 'Unknown' }}</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>
}
