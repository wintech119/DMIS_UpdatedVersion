<section class="page-grid">
  <mat-card class="panel">
    <div class="panel-header">
      <button mat-icon-button (click)="backToDashboard()" matTooltip="Back to Dashboard" class="back-btn">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-text">
        <h1>Needs List Preview</h1>
        <p>Read-only preview derived from inventory, transfer, and relief package data.</p>
      </div>
    </div>

    <form class="form-grid" [formGroup]="form" (ngSubmit)="generatePreview()">
      <mat-form-field appearance="outline">
        <mat-label>Event ID</mat-label>
        <input matInput type="number" min="1" formControlName="event_id" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Warehouse ID</mat-label>
        <input matInput type="number" min="1" formControlName="warehouse_id" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Phase</mat-label>
        <mat-select formControlName="phase">
          @for (phase of phaseOptions; track phase) {
            <mat-option [value]="phase">{{ phase }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>As Of (optional)</mat-label>
        <input matInput type="datetime-local" formControlName="as_of_datetime" />
      </mat-form-field>

      <div class="form-actions">
        <button matButton="filled" color="primary" type="submit" [disabled]="loading">
          Generate Preview
        </button>
        <button
          matButton="outlined"
          color="primary"
          type="button"
          [disabled]="loading || !can('replenishment.needs_list.create_draft')"
          (click)="createDraft()"
          >
          Create Draft
        </button>
      </div>
    </form>

    <div class="draft-loader">
      <mat-form-field appearance="outline">
        <mat-label>Load Draft ID</mat-label>
        <input matInput type="text" [(ngModel)]="draftIdInput" name="draftIdInput" />
      </mat-form-field>
      <button
        matButton="outlined"
        color="primary"
        type="button"
        [disabled]="loading"
        (click)="loadDraftById()"
        >
        Load Draft
      </button>
    </div>

    @if (errors.length) {
      <div class="errors">
        <div class="error-title">Request errors</div>
        @for (err of errors; track $index) {
          <div class="error-item">{{ err }}</div>
        }
      </div>
    }

    @if (workflowErrors.length) {
      <div class="errors">
        <div class="error-title">Workflow errors</div>
        @for (err of workflowErrors; track $index) {
          <div class="error-item">{{ err }}</div>
        }
      </div>
    }

    @if (dataNotes().length) {
      <div class="data-note">
        <div class="note-title">Data note</div>
        @for (note of dataNotes(); track $index) {
          <div class="note-item">{{ note }}</div>
        }
      </div>
    }
  </mat-card>

  @if (response; as draft) {
    <mat-card class="panel">
      <div class="summary-grid">
        <div>
          <div class="summary-label">As of</div>
          <div class="summary-value">{{ draft.as_of_datetime }}</div>
        </div>
        <div>
          <div class="summary-label">Planning window (days)</div>
          <div class="summary-value">{{ draft.planning_window_days }}</div>
        </div>
        <div>
          <div class="summary-label">Event / Warehouse</div>
          <div class="summary-value">
            {{ draft.event_id }} / {{ warehouseSummary(draft) }}
          </div>
        </div>
        <div>
          <div class="summary-label">Phase</div>
          <div class="summary-value">{{ draft.phase }}</div>
        </div>
      </div>
      <!-- Approval Status Tracker -->
      @if (draft.needs_list_id) {
        <dmis-approval-status-tracker
          [needsList]="response"
          [horizon]="approvalHorizon"
          (sendReminder)="onSendReminder()">
        </dmis-approval-status-tracker>
      }
    </mat-card>
  }

  @if (response; as draft) {
    <mat-card class="panel workflow">
      @if (draft.needs_list_id) {
        <div class="workflow-header">
          <div>
            <h2>Needs List Workflow</h2>
            <p>Drafts are stored locally for dev-only workflow testing.</p>
          </div>
          <div class="status-pill" [ngClass]="'status-' + statusValue().toLowerCase()">
            {{ statusValue() }}
          </div>
        </div>
        <div class="workflow-actions">
          <button
            matButton="filled"
            color="primary"
            type="button"
            [disabled]="!isDraftEditable() || !can('replenishment.needs_list.submit')"
            (click)="submitDraft()"
            >
            Submit
          </button>
        </div>
        @if (
          can('replenishment.needs_list.review_start') ||
          can('replenishment.needs_list.return') ||
          can('replenishment.needs_list.reject') ||
          can('replenishment.needs_list.approve') ||
          can('replenishment.needs_list.escalate')
          ) {
          <div
            class="review-panel"
            >
            <div class="section-label">Review Panel</div>
            @if (response.approval_summary; as summary) {
              <div class="approval-summary">
                <div class="approval-row">
                  <span class="approval-label">Total required</span>
                  <span>{{ summary.total_required_qty | number : '1.0-2' }}</span>
                </div>
                <div class="approval-row">
                  <span class="approval-label">Est. cost (JMD)</span>
                  <span>
                    {{ summary.total_estimated_cost === null ? 'N/A' : (summary.total_estimated_cost | number : '1.0-2') }}
                  </span>
                </div>
                @if (summary.approval) {
                  <div class="approval-row">
                    <span class="approval-label">Tier</span>
                    <span>{{ summary.approval.tier }}</span>
                  </div>
                }
                @if (summary.approval) {
                  <div class="approval-row">
                    <span class="approval-label">Approver</span>
                    <span>{{ summary.approval.approver_role }}</span>
                  </div>
                }
                @if (summary.approval) {
                  <div class="approval-row">
                    <span class="approval-label">Methods</span>
                    <span>{{ summary.approval.methods_allowed.join(', ') }}</span>
                  </div>
                }
                @if (summary.rationale) {
                  <div class="approval-row">
                    <span class="approval-label">Rationale</span>
                    <span>{{ summary.rationale }}</span>
                  </div>
                }
                @if (summary.escalation_required) {
                  <div class="approval-row">
                    <span class="approval-label">Escalation</span>
                    <span>Required by Appendix C authority rules</span>
                  </div>
                }
                @if (approvalWarnings().length) {
                  <div class="approval-warnings">
                    @for (warn of approvalWarnings(); track $index) {
                      <div class="approval-warning">
                        {{ warningLabel(warn) }}
                      </div>
                    }
                  </div>
                }
              </div>
            }
            <div class="workflow-actions">
              <button
                matButton="outlined"
                color="primary"
                type="button"
                [disabled]="!isStatus('SUBMITTED') || !can('replenishment.needs_list.review_start')"
                (click)="startReview()"
                >
                Start Review
              </button>
              <button
                matButton="outlined"
                type="button"
                [disabled]="!isStatus('UNDER_REVIEW') || !can('replenishment.needs_list.return')"
                (click)="returnDraft()"
                >
                Return
              </button>
              <button
                matButton="outlined"
                color="warn"
                type="button"
                [disabled]="!isStatus('UNDER_REVIEW') || !can('replenishment.needs_list.reject')"
                (click)="rejectDraft()"
                >
                Reject
              </button>
              <button
                matButton="filled"
                color="primary"
                type="button"
                [disabled]="!isStatus('UNDER_REVIEW') || !can('replenishment.needs_list.approve')"
                (click)="approveDraft()"
                >
                Approve
              </button>
              <button
                matButton="outlined"
                type="button"
                [disabled]="!isStatus('UNDER_REVIEW') || !can('replenishment.needs_list.escalate')"
                (click)="escalateDraft()"
                >
                Escalate
              </button>
            </div>
            @if (!isStatus('SUBMITTED')) {
              <div class="status-hint">
                Start Review is available only when status is SUBMITTED.
              </div>
            }
            @if (canExecute() || canCancel()) {
              <div
                class="review-panel execution-panel"
                >
                <div class="section-label">Execution</div>
                <div class="workflow-actions">
                  <button
                    matButton="outlined"
                    color="primary"
                    type="button"
                    [disabled]="!isStatus('APPROVED') || !canExecute()"
                    (click)="startPreparation()"
                    >
                    Start Preparation
                  </button>
                  <button
                    matButton="outlined"
                    type="button"
                    [disabled]="!isStatus('IN_PREPARATION') || !canExecute()"
                    (click)="markDispatched()"
                    >
                    Mark Dispatched
                  </button>
                  <button
                    matButton="outlined"
                    type="button"
                    [disabled]="!isStatus('DISPATCHED') || !canExecute()"
                    (click)="markReceived()"
                    >
                    Mark Received
                  </button>
                  <button
                    matButton="outlined"
                    color="primary"
                    type="button"
                    [disabled]="!isStatus('RECEIVED') || !canExecute()"
                    (click)="markCompleted()"
                    >
                    Mark Completed
                  </button>
                  <button
                    matButton="outlined"
                    color="warn"
                    type="button"
                    [disabled]="!canCancel() || !(isStatus('APPROVED') || isStatus('IN_PREPARATION'))"
                    (click)="cancelExecution()"
                    >
                    Cancel
                  </button>
                </div>
              </div>
            }
          </div>
        }
      }
    </mat-card>
  }

  @if (response) {
    <mat-card class="panel">
      <h2>Preview Results</h2>
      <div class="table-wrapper">
        <table mat-table [dataSource]="items" class="preview-table">
          <ng-container matColumnDef="item">
            <th mat-header-cell *matHeaderCellDef>Item</th>
            <td mat-cell *matCellDef="let item">{{ item.item_id }}</td>
          </ng-container>
          <ng-container matColumnDef="available">
            <th mat-header-cell *matHeaderCellDef>Available</th>
            <td mat-cell *matCellDef="let item">{{ item.available_qty | number : '1.0-2' }}</td>
          </ng-container>
          <ng-container matColumnDef="inbound">
            <th mat-header-cell *matHeaderCellDef>Inbound (Strict)</th>
            <td mat-cell *matCellDef="let item">
              {{ item.inbound_strict_qty | number : '1.0-2' }}
            </td>
          </ng-container>
          <ng-container matColumnDef="burn">
            <th mat-header-cell *matHeaderCellDef>Burn Rate / hr</th>
            <td mat-cell *matCellDef="let item">
              {{ item.burn_rate_per_hour | number : '1.0-4' }}
              @if (isEstimated(item)) {
                <mat-chip class="chip chip-estimated">Estimated</mat-chip>
              }
            </td>
          </ng-container>
          <ng-container matColumnDef="required">
            <th mat-header-cell *matHeaderCellDef>
              {{ isDraftEditable() && canEditLines() ? 'Override Qty' : 'Required Qty' }}
            </th>
            <td mat-cell *matCellDef="let item">
              @if (isDraftEditable() && canEditLines()) {
                <div class="qty-stack">
                  <div class="qty-line">
                    <span class="qty-label">Recommended</span>
                    <span>{{ recommendedQty(item) | number : '1.0-2' }}</span>
                  </div>
                  <div class="qty-line">
                    <span class="qty-label">Override</span>
                    <input
                      matInput
                      type="number"
                      class="qty-input"
                      [value]="overrideQty(item) ?? item.required_qty"
                      (input)="updateOverrideQty(item, $any($event.target).value)"
                      />
                  </div>
                  <div class="qty-line">
                    <span class="qty-label">Reason</span>
                    <input
                      matInput
                      type="text"
                      class="qty-input"
                      [value]="overrideReason(item)"
                      (input)="updateOverrideReason(item, $any($event.target).value)"
                      />
                  </div>
                  <button
                    matButton="outlined"
                    color="primary"
                    type="button"
                    class="override-action"
                    (click)="applyOverride(item)"
                    >
                    Apply
                  </button>
                </div>
              }
              @if (!isDraftEditable() || !canEditLines()) {
                <div>
                  {{ requiredQty(item) | number : '1.0-2' }}
                </div>
              }
              @if (canReviewComments() && isStatus('UNDER_REVIEW')) {
                <div
                  class="review-comment"
                  >
                  <span class="qty-label">Review Comment</span>
                  <input
                    matInput
                    type="text"
                    class="qty-input"
                    [value]="(reviewEdits[item.item_id] && reviewEdits[item.item_id].comment) || item.review_comment || ''"
                    (input)="updateReviewComment(item, $any($event.target).value)"
                    />
                  <button
                    matButton="outlined"
                    color="primary"
                    type="button"
                    class="override-action"
                    (click)="applyReviewComment(item)"
                    >
                    Save Comment
                  </button>
                </div>
              }
            </td>
          </ng-container>
          <ng-container matColumnDef="gap">
            <th mat-header-cell *matHeaderCellDef>Gap Qty</th>
            <td mat-cell *matCellDef="let item">{{ item.gap_qty | number : '1.0-2' }}</td>
          </ng-container>
          <ng-container matColumnDef="stockout">
            <th mat-header-cell *matHeaderCellDef>Time to Stockout</th>
            <td mat-cell *matCellDef="let item">{{ timeToStockout(item) }}</td>
          </ng-container>
          <ng-container matColumnDef="horizonA">
            <th mat-header-cell *matHeaderCellDef>Horizon A</th>
            <td mat-cell *matCellDef="let item">{{ horizonValue(item.horizon?.A) }}</td>
          </ng-container>
          <ng-container matColumnDef="horizonB">
            <th mat-header-cell *matHeaderCellDef>Horizon B</th>
            <td mat-cell *matCellDef="let item">{{ horizonValue(item.horizon?.B) }}</td>
          </ng-container>
          <ng-container matColumnDef="horizonC">
            <th mat-header-cell *matHeaderCellDef>Horizon C</th>
            <td mat-cell *matCellDef="let item">
              {{ horizonValue(item.horizon?.C) }}
              @if (item.procurement) {
                <div class="procurement-block">
                  <div class="procurement-title">Procurement (GOJEP)</div>
                  <div class="procurement-row">
                    <span class="procurement-label">Status</span>
                    <span>{{ item.procurement_status || 'RECOMMENDED' }}</span>
                  </div>
                  @if (item.procurement?.approval) {
                    <div class="procurement-row">
                      <span class="procurement-label">Approver</span>
                      <span>{{ item.procurement?.approval?.approver_role }}</span>
                    </div>
                  }
                  @if (item.procurement?.approval) {
                    <div class="procurement-row">
                      <span class="procurement-label">Methods</span>
                      <span>{{ item.procurement?.approval?.methods_allowed?.join(', ') }}</span>
                    </div>
                  }
                  <div class="procurement-row">
                    <span class="procurement-label">Lead time</span>
                    <span>{{ item.procurement?.lead_time_hours_default }}h</span>
                  </div>
                  @if (item.procurement?.gojep_note) {
                    <div class="procurement-note">
                      {{ item.procurement?.gojep_note?.label }} ({{ item.procurement?.gojep_note?.url }})
                    </div>
                  }
                </div>
              }
            </td>
          </ng-container>
          <ng-container matColumnDef="confidence">
            <th mat-header-cell *matHeaderCellDef>Confidence</th>
            <td mat-cell *matCellDef="let item">
              <mat-chip class="chip" [ngClass]="'chip-' + confidenceLevel(item)">
                {{ confidenceLevel(item) }}
              </mat-chip>
            </td>
          </ng-container>
          <ng-container matColumnDef="freshness">
            <th mat-header-cell *matHeaderCellDef>Freshness</th>
            <td mat-cell *matCellDef="let item">
              <mat-chip class="chip" [ngClass]="'chip-' + freshnessState(item)">
                {{ freshnessLabel(item) }}
              </mat-chip>
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>
      </div>
    </mat-card>
  }

  @if (response) {
    <mat-card class="panel warnings">
      <h2>Warnings</h2>
      @if (topWarnings.length) {
        <div class="warnings-section">
          <div class="section-label">Top-level warnings</div>
          <div class="warnings-summary" role="status" aria-live="polite">
            @for (warn of topWarnings; track $index) {
              <div class="warning-item">
                <span class="warning-icon" aria-hidden="true">!</span>
                <div class="warning-text">
                  <div class="warning-title">{{ warningLabel(warn) }}</div>
                  <div class="warning-code">Code: {{ warn }}</div>
                </div>
              </div>
            }
          </div>
        </div>
      }
      @if (topWarnings.length && perItemWarnings.length) {
        <mat-divider></mat-divider>
      }
      @if (perItemWarnings.length) {
        <div class="warnings-section">
          <div class="section-label">Per-item warnings</div>
          @for (entry of perItemWarnings; track entry) {
            <details class="item-warning">
              <summary class="item-label">Item {{ entry.item_id }}</summary>
              <mat-chip-listbox>
                @for (warn of entry.warnings; track $index) {
                  <mat-chip-option>{{ warn }}</mat-chip-option>
                }
              </mat-chip-listbox>
            </details>
          }
        </div>
      }
    </mat-card>
  }
</section>

