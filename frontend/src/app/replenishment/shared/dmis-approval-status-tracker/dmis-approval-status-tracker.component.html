@if (needsList?.needs_list_id) {
  <div class="tracker-container">
    <!-- Horizontal stepper row -->
    <div class="stepper-row" role="list" aria-label="Approval workflow status">
      @for (step of steps; track step; let i = $index; let last = $last) {
        <div class="step" [ngClass]="'step-' + step.state" role="listitem"
          [attr.aria-current]="step.state === 'active' ? 'step' : null">
          <div class="step-circle"
            [matTooltip]="step.timestamp ? (step.timestamp | date:'medium') : null">
            <mat-icon>{{ getStepIcon(step) }}</mat-icon>
          </div>
          <div class="step-label">{{ step.label }}</div>
          @if (step.state === 'completed' || step.state === 'active') {
            <div class="step-meta">
              @if (step.actor) {
                <span class="step-actor">{{ step.actor }}</span>
              }
              @if (step.timestamp) {
                <span class="step-time">{{ step.timestamp | date:'shortDate' }}</span>
              }
            </div>
          }
        </div>
        @if (!last) {
          <div class="step-connector"
            [class.completed]="step.state === 'completed'">
          </div>
        }
      }
    </div>
    <!-- Branch indicator (rejection/return/cancel) -->
    @if (branch) {
      <div class="branch-indicator"
        [ngClass]="'branch-' + branch.type.toLowerCase()"
        role="alert">
        <mat-icon class="branch-icon">{{ getBranchIcon() }}</mat-icon>
        <div class="branch-content">
          <span class="branch-label">{{ getBranchLabel() }}</span>
          @if (branch.reason) {
            <span class="branch-reason">{{ branch.reason }}</span>
          }
        </div>
      </div>
    }
    <!-- Pending approval info -->
    @if (isPendingApproval) {
      <div class="pending-info">
        <div class="approver-info">
          <mat-icon class="approver-icon">person</mat-icon>
          <span class="approver-role">Awaiting: <strong>{{ pendingApproverRole }}</strong></span>
          @if (approvalTier) {
            <span class="approval-tier">
              <mat-icon class="tier-icon">shield</mat-icon>
              {{ approvalTier }}
            </span>
          }
        </div>
        @if (pendingHours > 4) {
          <button matButton="outlined" color="warn" class="reminder-btn"
            (click)="onSendReminder(); $event.stopPropagation()"
            matTooltip="Send a notification to the approver">
            <mat-icon>notifications_active</mat-icon>
            Send Reminder ({{ pendingHours | number:'1.0-0' }}h pending)
          </button>
        }
      </div>
    }
    <!-- Expandable detail panel -->
    @if (detailsExpanded) {
      <div class="details-panel" [id]="panelId">
        <div class="timeline">
          @for (step of completedSteps; track step) {
            <div class="timeline-entry">
              <div class="timeline-dot" [ngClass]="'dot-' + step.state"></div>
              <div class="timeline-content">
                <div class="timeline-header">
                  <mat-icon class="timeline-icon">{{ step.icon }}</mat-icon>
                  <span class="timeline-label">{{ step.label }}</span>
                </div>
                <div class="timeline-meta">
                  @if (step.actor) {
                    <span class="timeline-actor">
                      <mat-icon class="inline-icon">person</mat-icon>
                      {{ step.actor }}
                    </span>
                  }
                  @if (step.timestamp) {
                    <span class="timeline-time">
                      <mat-icon class="inline-icon">schedule</mat-icon>
                      {{ step.timestamp | date:'medium' }}
                    </span>
                  }
                </div>
                @if (step.comment) {
                  <div class="timeline-comment">
                    <mat-icon class="inline-icon">comment</mat-icon>
                    "{{ step.comment }}"
                  </div>
                }
              </div>
            </div>
          }
          <!-- Branch entry in timeline -->
          @if (branch) {
            <div class="timeline-entry">
              <div class="timeline-dot" [ngClass]="'dot-' + branch.type.toLowerCase()"></div>
              <div class="timeline-content">
                <div class="timeline-header">
                  <mat-icon class="timeline-icon">{{ getBranchIcon() }}</mat-icon>
                  <span class="timeline-label">{{ getBranchLabel() }}</span>
                </div>
                @if (branch.actor) {
                  <div class="timeline-meta">
                    <span class="timeline-actor">
                      <mat-icon class="inline-icon">person</mat-icon>
                      {{ branch.actor }}
                    </span>
                  </div>
                }
                @if (branch.reason) {
                  <div class="timeline-comment">
                    <mat-icon class="inline-icon">comment</mat-icon>
                    "{{ branch.reason }}"
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>
    }
    <!-- Toggle details button -->
    <button
      mat-button
      class="toggle-details"
      (click)="toggleDetails()"
      [attr.aria-expanded]="detailsExpanded"
      [attr.aria-controls]="panelId">
      <mat-icon>{{ detailsExpanded ? 'expand_less' : 'expand_more' }}</mat-icon>
      {{ detailsExpanded ? 'Hide Details' : 'View History' }}
    </button>
  </div>
}

