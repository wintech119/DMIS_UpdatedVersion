<div class="review-queue-page">
  <!-- Header -->
  <div class="page-header">
    <button mat-icon-button class="back-btn" (click)="backToDashboard()" aria-label="Back to dashboard">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <div class="header-text">
      <h1>Needs List Review Queue</h1>
      <p class="subtitle">Needs lists pending your review and approval</p>
    </div>
    <button mat-flat-button color="primary" (click)="loadQueue()" class="refresh-btn">
      <mat-icon>refresh</mat-icon>
      Refresh
    </button>
  </div>

  <!-- Loading skeleton -->
  @if (loading()) {
    <dmis-skeleton-loader variant="table-row" [count]="5"></dmis-skeleton-loader>
  }

  <!-- Error state -->
  @if (error() && !loading()) {
    <dmis-empty-state
      icon="error_outline"
      title="Failed to load review queue"
      message="There was an error loading the pending needs lists. Please try again."
      actionLabel="Retry"
      actionIcon="refresh"
      (action)="loadQueue()">
    </dmis-empty-state>
  }

  <!-- Empty state -->
  @if (!loading() && !error() && needsLists().length === 0) {
    <dmis-empty-state
      icon="inbox"
      title="No needs lists pending approval"
      message="There are currently no submitted needs lists awaiting review."
      actionLabel="Back to Dashboard"
      actionIcon="dashboard"
      (action)="backToDashboard()">
    </dmis-empty-state>
  }

  @if (!loading() && !error() && needsLists().length > 0) {
    <div class="filters-panel" role="region" aria-label="Needs list submission filters">
      <!-- Collapsed bar -->
      <div class="filters-bar">
        <button
          class="filters-toggle"
          type="button"
          (click)="toggleFilters()"
          [attr.aria-expanded]="filtersExpanded()"
          aria-controls="filtersContent">
          <mat-icon class="filter-icon">filter_list</mat-icon>
          <span class="filters-title">Filters</span>
          @if (activeFilterCount() > 0) {
            <span class="filter-count-badge">{{ activeFilterCount() }}</span>
          }
          <mat-icon class="chevron-icon" [class.expanded]="filtersExpanded()">expand_more</mat-icon>
        </button>

        <div class="filters-bar-right">
          <span class="filter-summary" aria-live="polite">
            {{ filteredNeedsLists().length }} of {{ needsLists().length }} submissions
          </span>
          @if (hasActiveFilters()) {
            <button mat-stroked-button class="clear-btn" type="button" (click)="clearFilters()">
              <mat-icon>close</mat-icon>
              Clear
            </button>
          }
        </div>
      </div>

      <!-- Expanded filter grid -->
      @if (filtersExpanded()) {
        <div class="filters-content" id="filtersContent">
          <div class="filters-grid">
            <label class="filter-field filter-search">
              <span class="filter-label">Search Submissions</span>
              <input
                type="text"
                class="filter-input"
                [value]="searchQuery()"
                (input)="onSearchInput($event)"
                placeholder="Needs list, event, warehouse, submitter">
            </label>

            <label class="filter-field">
              <span class="filter-label">Status</span>
              <select class="filter-select" [value]="selectedStatus()" (change)="onStatusFilterChange($event)">
                <option value="ALL">All statuses</option>
                @for (option of statusFilterOptions(); track option.value) {
                  <option [value]="option.value">{{ option.label }}</option>
                }
              </select>
            </label>

            <label class="filter-field">
              <span class="filter-label">Phase</span>
              <select class="filter-select" [value]="selectedPhase()" (change)="onPhaseFilterChange($event)">
                <option value="ALL">All phases</option>
                @for (phase of phaseFilterOptions(); track phase) {
                  <option [value]="phase">{{ phase }}</option>
                }
              </select>
            </label>

            <label class="filter-field">
              <span class="filter-label">Submitted By</span>
              <select class="filter-select" [value]="selectedSubmitter()" (change)="onSubmitterFilterChange($event)">
                <option value="ALL">All submitters</option>
                @for (submitter of submitterFilterOptions(); track submitter) {
                  <option [value]="submitter">{{ submitter }}</option>
                }
              </select>
            </label>
          </div>
          <p class="queue-hint">Select a submission to open full review details.</p>
        </div>
      }
    </div>

    @if (filteredNeedsLists().length === 0) {
      <dmis-empty-state
        icon="filter_alt_off"
        title="No submissions match your filters"
        message="Try adjusting or clearing the current filters to see more needs lists."
        actionLabel="Clear Filters"
        actionIcon="restart_alt"
        (action)="clearFilters()">
      </dmis-empty-state>
    }

    @if (filteredNeedsLists().length > 0) {
      <!-- Desktop table -->
      <div class="table-container desktop-only">
        <table mat-table [dataSource]="filteredNeedsLists()" class="review-table">

          <ng-container matColumnDef="needs_list_ref">
            <th mat-header-cell *matHeaderCellDef>Needs List #</th>
            <td mat-cell *matCellDef="let row">
              <span class="id-cell" [matTooltip]="needsListReferenceTooltip(row)">{{ needsListReference(row) }}</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="event_id">
            <th mat-header-cell *matHeaderCellDef>Event</th>
            <td mat-cell *matCellDef="let row">{{ row.event_name ?? ('Event ' + row.event_id) }}</td>
          </ng-container>

          <ng-container matColumnDef="phase">
            <th mat-header-cell *matHeaderCellDef>Phase</th>
            <td mat-cell *matCellDef="let row">
              <span class="phase-chip" [attr.data-phase]="row.phase">{{ row.phase }}</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="warehouse">
            <th mat-header-cell *matHeaderCellDef>Warehouse</th>
            <td mat-cell *matCellDef="let row">{{ warehouseLabel(row) }}</td>
          </ng-container>

          <ng-container matColumnDef="submitted_by">
            <th mat-header-cell *matHeaderCellDef>Submitted By</th>
            <td mat-cell *matCellDef="let row">{{ row.submitted_by ?? 'N/A' }}</td>
          </ng-container>

          <ng-container matColumnDef="submitted_at">
            <th mat-header-cell *matHeaderCellDef>Submitted At</th>
            <td mat-cell *matCellDef="let row">
              {{ row.submitted_at ? (row.submitted_at | date:'short') : 'N/A' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="items_count">
            <th mat-header-cell *matHeaderCellDef>Items</th>
            <td mat-cell *matCellDef="let row">{{ itemsCount(row) }}</td>
          </ng-container>

          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let row">
              <span class="status-chip" [attr.data-status]="row.status">
                <mat-icon class="status-icon">{{ statusIcon(row.status) }}</mat-icon>
                {{ statusLabel(row.status) }}
              </span>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row
              *matRowDef="let row; columns: displayedColumns;"
              class="clickable-row"
              (click)="openReview(row)"
              tabindex="0"
              (keydown.enter)="openReview(row)"
              [attr.aria-label]="reviewAriaLabel(row)"
              role="link">
          </tr>
        </table>
      </div>

      <!-- Mobile card list -->
      <div class="mobile-only card-list">
        @for (row of filteredNeedsLists(); track row.needs_list_id ?? row.needs_list_no ?? $index) {
          <mat-card class="review-card"
                    (click)="openReview(row)"
                    tabindex="0"
                    (keydown.enter)="openReview(row)"
                    [attr.aria-label]="reviewAriaLabel(row)"
                    role="link">
            <mat-card-header>
              <span class="status-chip" [attr.data-status]="row.status">
                <mat-icon class="status-icon">{{ statusIcon(row.status) }}</mat-icon>
                {{ statusLabel(row.status) }}
              </span>
            </mat-card-header>
            <mat-card-content>
              <div class="card-field">
                <span class="card-label">Needs List #</span>
                <span [matTooltip]="needsListReferenceTooltip(row)">{{ needsListReference(row) }}</span>
              </div>
              <div class="card-field">
                <span class="card-label">Event</span>
                <span>{{ row.event_name ?? ('Event ' + row.event_id) }}</span>
              </div>
              <div class="card-field">
                <span class="card-label">Phase</span>
                <span class="phase-chip" [attr.data-phase]="row.phase">{{ row.phase }}</span>
              </div>
              <div class="card-field">
                <span class="card-label">Warehouse</span>
                <span>{{ warehouseLabel(row) }}</span>
              </div>
              <div class="card-field">
                <span class="card-label">Submitted By</span>
                <span>{{ row.submitted_by ?? 'N/A' }}</span>
              </div>
              <div class="card-field">
                <span class="card-label">Submitted</span>
                <span>{{ row.submitted_at ? (row.submitted_at | date:'short') : 'N/A' }}</span>
              </div>
              <div class="card-field">
                <span class="card-label">Items</span>
                <span>{{ itemsCount(row) }}</span>
              </div>
            </mat-card-content>
            <mat-card-actions align="end">
              <button mat-button color="primary">
                <mat-icon>chevron_right</mat-icon>
                Review
              </button>
            </mat-card-actions>
          </mat-card>
        }
      </div>
    }
  }
</div>
