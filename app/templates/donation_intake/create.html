{% extends 'base.html' %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/relief-requests-ui.css') }}">
{% endblock %}

{% block title %}Select Donation for Intake{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="page-header mb-0">
            <div class="page-title">
                <i class="bi bi-box-arrow-in-down page-title-icon"></i>
                <h1 class="page-title-text">Select Donation & Warehouse</h1>
            </div>
            <p class="text-muted mb-0">Choose a verified donation and target warehouse for intake</p>
        </div>
        <a href="{{ url_for('donation_intake.list_intakes') }}" class="btn-relief-secondary">
            <i class="bi bi-arrow-left"></i>
            Back to List
        </a>
    </div>

    <!-- Selection Form -->
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-1-circle-fill text-primary"></i>
                        Step 1: Select Donation and Warehouse
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form method="POST" action="{{ url_for('donation_intake.create_intake') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <!-- Donation Selection -->
                        <div class="mb-4">
                            <label for="donation_id" class="form-label fw-bold required">
                                <i class="bi bi-gift"></i>
                                Verified Donation
                            </label>
                            <select class="form-select form-select-lg" 
                                    name="donation_id" 
                                    id="donation_id" 
                                    required
                                    data-action="show-donation-details">
                                <option value="">-- Select a verified donation --</option>
                                {% for donation in verified_donations %}
                                <option value="{{ donation.donation_id }}"
                                        data-donor="{{ donation.donor.donor_name }}"
                                        data-desc="{{ donation.donation_desc }}"
                                        data-date="{{ donation.received_date|format_date }}">
                                    #{{ donation.donation_id }} - {{ donation.donation_desc|truncate(60) }} ({{ donation.donor.donor_name }})
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i>
                                Only verified donations (status='V') are available for intake
                            </div>
                            
                            <!-- Donation Details (shown when selected) -->
                            <div id="donation-details" class="mt-3 d-none">
                                <div class="card border-primary">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="bi bi-info-circle text-primary"></i>
                                            Selected Donation Details
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <small class="text-muted d-block">Donor</small>
                                                <strong id="detail-donor"></strong>
                                            </div>
                                            <div class="col-md-6">
                                                <small class="text-muted d-block">Received Date</small>
                                                <strong id="detail-date"></strong>
                                            </div>
                                        </div>
                                        <div class="mb-0">
                                            <small class="text-muted d-block">Description</small>
                                            <strong id="detail-desc"></strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Warehouse Selection -->
                        <div class="mb-4">
                            <label for="inventory_id" class="form-label fw-bold required">
                                <i class="bi bi-building"></i>
                                Target Warehouse
                            </label>
                            <select class="form-select form-select-lg" 
                                    name="inventory_id" 
                                    id="inventory_id" 
                                    required>
                                <option value="">-- Select warehouse for intake --</option>
                                {% for warehouse in warehouses %}
                                <option value="{{ warehouse.warehouse_id }}">
                                    {{ warehouse.warehouse_name }} - {{ warehouse.location_name }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i>
                                Select the warehouse where items will be received
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between pt-3 border-top">
                            <a href="{{ url_for('donation_intake.list_intakes') }}" class="btn-relief-secondary">
                                <i class="bi bi-x-circle"></i>
                                Cancel
                            </a>
                            <button type="submit" class="btn-relief-primary">
                                <i class="bi bi-arrow-right-circle"></i>
                                Continue to Intake Form
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Card -->
            <div class="card mt-3">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="bi bi-question-circle text-primary"></i>
                        About Donation Intake
                    </h6>
                    <p class="card-text mb-2">
                        The donation intake process allows you to:
                    </p>
                    <ul class="mb-0">
                        <li>Record donation items into warehouse inventory</li>
                        <li>Track batch numbers and expiry dates</li>
                        <li>Specify quantities (usable, defective, expired)</li>
                        <li>Automatically update inventory totals</li>
                        <li>Mark donations as processed</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script nonce="{{ csp_nonce() }}">
function showDonationDetails() {
    const select = document.getElementById('donation_id');
    const option = select.options[select.selectedIndex];
    
    if (option.value) {
        document.getElementById('detail-donor').textContent = option.dataset.donor;
        document.getElementById('detail-desc').textContent = option.dataset.desc;
        document.getElementById('detail-date').textContent = option.dataset.date;
        
        document.getElementById('donation-details').classList.remove('d-none');
        document.getElementById('donation-details').classList.add('d-block');
    } else {
        document.getElementById('donation-details').classList.remove('d-block');
        document.getElementById('donation-details').classList.add('d-none');
    }
}
</script>
{% endblock %}
