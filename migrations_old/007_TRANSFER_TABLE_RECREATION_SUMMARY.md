# Migration 007: Transfer Table Recreation

## Overview
Dropped and recreated the `transfer` table to align with DRIMS naming standards and schema specifications. This migration corrects foreign key references, adds missing status codes, and standardizes constraint naming.

## Migration Date
November 18, 2025

## Changes Applied

### Schema Changes

#### 1. Column Renaming
- **Old**: `event_id`
- **New**: `eligible_event_id`
- **Reason**: Clarifies that the event reference is for eligible event tracking

#### 2. Foreign Key Reference Correction
- **Old**: `fr_inventory_id` and `to_inventory_id` referenced `inventory(inventory_id)`
- **New**: Both reference `warehouse(warehouse_id)`
- **Reason**: These columns represent warehouse IDs, not inventory IDs. The naming `fr_inventory_id` and `to_inventory_id` is preserved for historical ODPEM compatibility, but they now correctly reference warehouse table.

#### 3. Status Code Expansion
- **Old**: `status_code IN ('D', 'C', 'V')`
- **New**: `status_code IN ('D', 'C', 'V', 'P')`
- **Added**: 'P' = Processed (transfer intake completed)

#### 4. Default Value Addition
- **Field**: `transfer_date`
- **Default**: `CURRENT_DATE`
- **Reason**: Ensures transfer date is automatically set to current date when not specified

#### 5. Constraint Naming Standardization
- **Old**: `transfer_pkey`, `transfer_transfer_date_check`
- **New**: `pk_transfer`, `c_transfer_1`, `c_transfer_2`
- **Reason**: Follows DRIMS naming convention (pk_, c_, fk_, dk_ prefixes)

### Status Code Meanings
- **D** = Draft (transfer being prepared)
- **C** = Completed (transfer executed)
- **V** = Verified (transfer verified at destination)
- **P** = Processed (transfer intake completed at destination warehouse)

## Technical Details

### Tables Dropped and Recreated
Since the transfer table had dependent tables, the following cascade drop was performed:
1. `xfintake_item` (0 rows) - depends on xfintake
2. `xfintake` (0 rows) - references transfer
3. `transfer_item` (0 rows) - references transfer
4. `transfer` (0 rows) - parent table

### New Table Structure
```sql
CREATE TABLE transfer
(
    transfer_id INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY
        CONSTRAINT pk_transfer PRIMARY KEY,
    fr_inventory_id INTEGER NOT NULL
        CONSTRAINT fk_transfer_warehouse1 REFERENCES warehouse(warehouse_id),
    to_inventory_id INTEGER NOT NULL
        CONSTRAINT fk_transfer_warehouse2 REFERENCES warehouse(warehouse_id),
    eligible_event_id INTEGER
        CONSTRAINT fk_transfer_event REFERENCES event(event_id),
    transfer_date DATE NOT NULL DEFAULT CURRENT_DATE
        CONSTRAINT c_transfer_1 CHECK (transfer_date <= CURRENT_DATE),
    reason_text VARCHAR(255),
    status_code CHAR(1) NOT NULL
        CONSTRAINT c_transfer_2 CHECK (status_code IN ('D','C','V','P')),
    create_by_id VARCHAR(20) NOT NULL,
    create_dtime TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,
    update_by_id VARCHAR(20) NOT NULL,
    update_dtime TIMESTAMP(0) WITHOUT TIME ZONE,
    verify_by_id VARCHAR(20) NOT NULL,
    verify_dtime TIMESTAMP(0) WITHOUT TIME ZONE,
    version_nbr INTEGER NOT NULL
);
```

### Indexes Created
```sql
CREATE INDEX dk_transfer_1 ON transfer(transfer_date);
CREATE INDEX dk_transfer_2 ON transfer(fr_inventory_id);
CREATE INDEX dk_transfer_3 ON transfer(to_inventory_id);
```

### Data Impact
- **Zero data loss**: All tables had 0 rows before migration
- **Dependent tables**: Will be recreated by SQLAlchemy on application restart
- **Foreign key integrity**: Fully maintained

## Validation Results

### Constraints Verified
✅ Primary key: `pk_transfer`
✅ Check constraint: `c_transfer_1` (transfer_date <= CURRENT_DATE)
✅ Check constraint: `c_transfer_2` (status_code IN ('D','C','V','P'))
✅ Foreign key: `fk_transfer_warehouse1` (fr_inventory_id → warehouse)
✅ Foreign key: `fk_transfer_warehouse2` (to_inventory_id → warehouse)
✅ Foreign key: `fk_transfer_event` (eligible_event_id → event)

### Indexes Verified
✅ dk_transfer_1 on transfer_date
✅ dk_transfer_2 on fr_inventory_id
✅ dk_transfer_3 on to_inventory_id

## SQLAlchemy Model Updates

### Updated Transfer Model
```python
class Transfer(db.Model):
    """Transfer between warehouses
    
    Tracks inventory transfers between warehouses with batch-level detail.
    Foreign keys reference warehouse directly (fr_inventory_id and to_inventory_id
    are conceptually inventory IDs but reference warehouse.warehouse_id).
    
    Status Codes:
        D = Draft (transfer being prepared)
        C = Completed (transfer executed)
        V = Verified (transfer verified at destination)
        P = Processed (transfer intake completed)
    """
    __tablename__ = 'transfer'
    
    transfer_id = db.Column(db.Integer, primary_key=True)
    fr_inventory_id = db.Column(db.Integer, db.ForeignKey('warehouse.warehouse_id'), nullable=False)
    to_inventory_id = db.Column(db.Integer, db.ForeignKey('warehouse.warehouse_id'), nullable=False)
    eligible_event_id = db.Column(db.Integer, db.ForeignKey('event.event_id'))
    transfer_date = db.Column(db.Date, nullable=False, server_default=db.text('CURRENT_DATE'))
    reason_text = db.Column(db.String(255))
    status_code = db.Column(db.CHAR(1), nullable=False)
    # ... audit fields ...
    
    __table_args__ = (
        db.CheckConstraint("transfer_date <= CURRENT_DATE", name='c_transfer_1'),
        db.CheckConstraint("status_code IN ('D', 'C', 'V', 'P')", name='c_transfer_2'),
        db.Index('dk_transfer_1', 'transfer_date'),
        db.Index('dk_transfer_2', 'fr_inventory_id'),
        db.Index('dk_transfer_3', 'to_inventory_id'),
    )
    
    from_warehouse = db.relationship('Warehouse', foreign_keys=[fr_inventory_id], backref='transfers_sent')
    to_warehouse = db.relationship('Warehouse', foreign_keys=[to_inventory_id], backref='transfers_received')
    event = db.relationship('Event', foreign_keys=[eligible_event_id], backref='transfers')
```

### Relationship Changes
- **Old**: `from_inventory`, `to_inventory` → Inventory model
- **New**: `from_warehouse`, `to_warehouse` → Warehouse model
- **Reason**: Correctly reflects that transfers happen between warehouses

## Files Modified
1. `migrations/007_recreate_transfer_table.sql` - Migration SQL
2. `app/db/models.py` - Updated Transfer model with correct relationships and constraints
3. `replit.md` - Updated database architecture documentation

## Important Notes

### Historical Naming Convention
The column names `fr_inventory_id` and `to_inventory_id` are preserved from the original ODPEM AIDMGMT schema for compatibility, even though they now reference `warehouse(warehouse_id)`. This is by design:
- In ODPEM terminology, "inventory" refers to warehouse stock
- The warehouse table represents physical locations where inventory is stored
- Transfer operations move inventory between warehouse locations

### Dependent Tables
The following tables were dropped during migration and will be automatically recreated by SQLAlchemy with matching foreign keys:
- `transfer_item` - Links transfer to specific items/batches being transferred
- `xfintake` - Transfer intake records at destination warehouse
- `xfintake_item` - Items received during transfer intake

## Next Steps
The transfer table is now ready to support the complete transfer workflow with four distinct status states (Draft, Completed, Verified, Processed), enabling proper tracking of inventory movements between warehouses from initiation through final processing.
