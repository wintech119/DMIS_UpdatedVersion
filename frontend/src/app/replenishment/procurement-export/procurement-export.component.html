<div class="procurement-export-page">
  <!-- Page Header -->
  <div class="page-header">
    <button mat-icon-button class="back-btn" type="button" aria-label="Back to tracker" (click)="backToTracker()">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <div class="header-text">
      <h1>Procurement Export</h1>
      <p class="subtitle">Horizon C - Items requiring external procurement</p>
    </div>
  </div>

  <!-- Loading skeleton -->
  @if (loading()) {
    <dmis-skeleton-loader variant="summary-card" [count]="2"></dmis-skeleton-loader>
  }

  <!-- Error state -->
  @if (!loading() && error()) {
    <dmis-empty-state
      icon="error_outline"
      title="Unable to load procurement items"
      message="There was an error loading procurement data. Please try again."
      actionLabel="Back to Tracker"
      actionIcon="arrow_back"
      (action)="backToTracker()">
    </dmis-empty-state>
  }

  @if (!loading() && !error()) {
    <!-- Info banner -->
    <div class="info-banner">
      <mat-icon aria-hidden="true">info</mat-icon>
      <div>
        <strong>Full procurement module coming soon</strong>
        <span>For now, export the procurement request and process it manually through the standard procurement workflow.</span>
      </div>
    </div>

    <!-- Export buttons -->
    <div class="export-section">
      <button
        mat-flat-button
        color="primary"
        type="button"
        [disabled]="exporting() || !hasLines()"
        (click)="exportAs('csv')">
        <mat-icon>download</mat-icon>
        {{ exporting() ? 'Exporting...' : 'Export as CSV' }}
      </button>
    </div>

    <!-- Items table -->
    @if (hasLines()) {
      <!-- Desktop table -->
      <div class="items-table-container desktop-only">
        <table class="items-table">
          <thead>
            <tr>
              <th>Item</th>
              <th>UOM</th>
              <th>Required Qty</th>
              <th>Est. Unit Cost</th>
              <th>Est. Total Cost</th>
            </tr>
          </thead>
          <tbody>
            @for (line of lines(); track line.item_id) {
              <tr>
                <td>{{ line.item_name }}</td>
                <td>{{ line.uom }}</td>
                <td class="qty-cell">{{ line.required_qty | number:'1.0-2' }}</td>
                <td class="cost-cell">
                  @if (line.est_unit_cost) {
                    {{ line.est_unit_cost | currency:'JMD':'symbol-narrow':'1.0-0' }}
                  } @else {
                    <span class="na">N/A</span>
                  }
                </td>
                <td class="cost-cell">
                  @if (line.est_total_cost) {
                    {{ line.est_total_cost | currency:'JMD':'symbol-narrow':'1.0-0' }}
                  } @else {
                    <span class="na">N/A</span>
                  }
                </td>
              </tr>
            }
          </tbody>
          <tfoot>
            <tr>
              <td colspan="4" class="total-label">Total Estimated Cost</td>
              <td class="cost-cell total-value">
                @if (totalEstimatedCost() > 0) {
                  {{ totalEstimatedCost() | currency:'JMD':'symbol-narrow':'1.0-0' }}
                } @else {
                  <span class="na">N/A</span>
                }
              </td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Mobile cards -->
      <div class="item-cards mobile-only">
        @for (line of lines(); track line.item_id) {
          <div class="item-card">
            <div class="item-card-header">
              <strong>{{ line.item_name }}</strong>
              <span class="item-uom">{{ line.uom }}</span>
            </div>
            <div class="item-card-body">
              <div class="item-field">
                <span class="field-label">Required Qty</span>
                <span>{{ line.required_qty | number:'1.0-2' }}</span>
              </div>
              <div class="item-field">
                <span class="field-label">Est. Unit Cost</span>
                <span>{{ line.est_unit_cost ? (line.est_unit_cost | currency:'JMD':'symbol-narrow':'1.0-0') : 'N/A' }}</span>
              </div>
              <div class="item-field">
                <span class="field-label">Est. Total Cost</span>
                <span>{{ line.est_total_cost ? (line.est_total_cost | currency:'JMD':'symbol-narrow':'1.0-0') : 'N/A' }}</span>
              </div>
            </div>
          </div>
        }
      </div>
    }

    @if (!hasLines()) {
      <dmis-empty-state
        icon="shopping_cart"
        title="No Horizon C items"
        message="This needs list does not have any items requiring external procurement.">
      </dmis-empty-state>
    }
  }
</div>
