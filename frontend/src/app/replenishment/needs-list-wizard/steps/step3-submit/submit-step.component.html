<div class="submit-step-container">
  <!-- Summary Header -->
  <mat-card class="summary-card">
    <mat-card-header>
      <mat-card-title>Needs List Summary</mat-card-title>
      <mat-card-subtitle>Review and submit for approval</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="summary-grid">
        <div class="summary-item">
          <mat-icon class="summary-icon" aria-hidden="true">inventory_2</mat-icon>
          <div class="summary-text">
            <span class="label">Total Items</span>
            <span class="value">{{ totalItems }}</span>
            @if (totalReviewed > 0) {
              <span class="context">(of {{ totalReviewed }} reviewed)</span>
            }
          </div>
        </div>
        <div class="summary-item">
          <mat-icon class="summary-icon" aria-hidden="true">widgets</mat-icon>
          <div class="summary-text">
            <span class="label">Total Units</span>
            <span class="value">{{ totalUnits }}</span>
          </div>
        </div>
        <div class="summary-item">
          <mat-icon class="summary-icon" aria-hidden="true">attach_money</mat-icon>
          <div class="summary-text">
            <span class="label">Estimated Cost</span>
            <span class="value">${{ totalCost | number:'1.2-2' }}</span>
          </div>
        </div>
        @if (hasAdjustments) {
          <div class="summary-item">
            <mat-icon class="summary-icon" aria-hidden="true">edit</mat-icon>
            <div class="summary-text">
              <span class="label">Adjustments</span>
              <span class="value">{{ adjustmentCount }}</span>
            </div>
          </div>
        }
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Main Content Grid -->
  <div class="content-grid">
    <!-- Left Column -->
    <div class="left-column">
      <!-- Warehouse Breakdown -->
      <mat-card class="breakdown-card">
        <mat-card-header>
          <mat-icon class="card-icon" aria-hidden="true">store</mat-icon>
          <mat-card-title>Warehouse Breakdown</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="warehouse-list">
            @for (wh of warehouseBreakdown; track wh) {
              <div class="warehouse-item">
                <div class="wh-header">
                  <mat-icon class="wh-icon">location_on</mat-icon>
                  <span class="wh-name">{{ wh.warehouse_name }}</span>
                </div>
                <div class="wh-stats">
                  <div class="stat">
                    <span class="stat-label">Items:</span>
                    <span class="stat-value">{{ wh.items }}</span>
                  </div>
                  <div class="stat">
                    <span class="stat-label">Units:</span>
                    <span class="stat-value">{{ wh.units }}</span>
                  </div>
                  <div class="stat">
                    <span class="stat-label">Cost:</span>
                    <span class="stat-value">{{ wh.cost | currency:'USD':'symbol':'1.2-2' }}</span>
                  </div>
                </div>
              </div>
            }

            @if (warehouseBreakdown.length === 0) {
              <dmis-empty-state
                icon="inventory_2"
                title="No Items Selected"
                message="No items have been selected for submission. Go back to Step 2 to review and select items."
                actionLabel="Go Back"
                actionIcon="arrow_back"
                (action)="goBack()"
              ></dmis-empty-state>
            }
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Horizon Breakdown -->
      <mat-card class="breakdown-card">
        <mat-card-header>
          <mat-icon class="card-icon" aria-hidden="true">timeline</mat-icon>
          <mat-card-title>Replenishment Horizons</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="horizon-list">
            <!-- Horizon A: Transfer -->
            <div class="horizon-item horizon-A">
              <div class="horizon-header">
                <mat-icon class="horizon-icon">local_shipping</mat-icon>
                <div class="horizon-info">
                  <div class="horizon-title">
                    <span class="horizon-label">Transfer (Horizon A)</span>
                    <span class="horizon-tag" aria-label="Horizon A">Horizon A</span>
                  </div>
                  <span class="horizon-lead-time">Lead Time: 6-8 hours</span>
                </div>
              </div>
              @if (getHorizonItems('A') > 0) {
                <div class="horizon-stats">
                  <div class="stat">
                    <span class="stat-label">Items:</span>
                    <span class="stat-value">{{ getHorizonItems('A') }}</span>
                  </div>
                  <div class="stat">
                    <span class="stat-label">Units:</span>
                    <span class="stat-value">{{ getHorizonUnits('A') }}</span>
                  </div>
                </div>
              } @else {
                <div class="empty-notice">
                  <span class="empty-text">No items allocated</span>
                </div>
              }
            </div>

            <!-- Horizon B: Donation -->
            <div class="horizon-item horizon-B">
              <div class="horizon-header">
                <mat-icon class="horizon-icon">inventory</mat-icon>
                <div class="horizon-info">
                  <div class="horizon-title">
                    <span class="horizon-label">Donation (Horizon B)</span>
                    <span class="horizon-tag" aria-label="Horizon B">Horizon B</span>
                  </div>
                  <span class="horizon-lead-time">Lead Time: 2-7 days</span>
                </div>
              </div>
              @if (getHorizonItems('B') > 0) {
                <div class="horizon-stats">
                  <div class="stat">
                    <span class="stat-label">Items:</span>
                    <span class="stat-value">{{ getHorizonItems('B') }}</span>
                  </div>
                  <div class="stat">
                    <span class="stat-label">Units:</span>
                    <span class="stat-value">{{ getHorizonUnits('B') }}</span>
                  </div>
                </div>
              } @else {
                <div class="empty-notice">
                  <span class="empty-text">No items allocated</span>
                </div>
              }
            </div>

            <!-- Horizon C: Procurement -->
            <div class="horizon-item horizon-C">
              <div class="horizon-header">
                <mat-icon class="horizon-icon">shopping_cart</mat-icon>
                <div class="horizon-info">
                  <div class="horizon-title">
                    <span class="horizon-label">Procurement (Horizon C)</span>
                    <span class="horizon-tag" aria-label="Horizon C">Horizon C</span>
                  </div>
                  <span class="horizon-lead-time">Lead Time: 14+ days</span>
                </div>
              </div>
              @if (getHorizonItems('C') > 0) {
                <div class="horizon-stats">
                  <div class="stat">
                    <span class="stat-label">Items:</span>
                    <span class="stat-value">{{ getHorizonItems('C') }}</span>
                  </div>
                  <div class="stat">
                    <span class="stat-label">Units:</span>
                    <span class="stat-value">{{ getHorizonUnits('C') }}</span>
                  </div>
                </div>
              } @else {
                <div class="empty-notice">
                  <span class="empty-text">No items allocated</span>
                </div>
              }
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Items Preview -->
      @if (selectedItems.length > 0) {
        <mat-card class="items-preview-card">
          <mat-card-header>
            <div class="header-content">
              <div class="header-left">
                <mat-icon class="card-icon" aria-hidden="true">list</mat-icon>
                <mat-card-title>Items to be Submitted ({{ selectedItems.length }})</mat-card-title>
              </div>
              <button mat-button (click)="toggleItemsList()" class="toggle-btn">
                {{ showAllItems ? 'Collapse' : 'View All' }}
                <mat-icon>{{ showAllItems ? 'expand_less' : 'expand_more' }}</mat-icon>
              </button>
            </div>
          </mat-card-header>
          @if (showAllItems) {
            <mat-card-content>
              <div class="items-list">
                @for (item of selectedItems; track item) {
                  <div class="item-row">
                    <div class="item-info">
                      <span class="item-name">{{ item.item_name || 'Item ' + item.item_id }}</span>
                      <span class="item-id">ID: {{ item.item_id }}</span>
                    </div>
                    <div class="item-details">
                      <span class="item-warehouse">{{ item.warehouse_name || item.warehouse_id }}</span>
                      <span class="item-qty">{{ getAdjustedQty(item) }} units</span>
                      <span class="item-cost">{{ getItemCost(item) | currency:'USD':'symbol':'1.2-2' }}</span>
                    </div>
                  </div>
                }
              </div>
            </mat-card-content>
          }
        </mat-card>
      }
    </div>

    <!-- Right Column -->
    <div class="right-column">
      <!-- Event & Phase Info -->
      <mat-card class="info-card">
        <mat-card-header>
          <mat-icon class="card-icon" aria-hidden="true">event</mat-icon>
          <mat-card-title>Event Information</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="info-row">
            <span class="info-label">Event:</span>
            <span class="info-value">{{ getEventName() }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Phase:</span>
            <mat-chip class="phase-chip">{{ getPhaseLabel() }}</mat-chip>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Replenishment Method (with radio selection) -->
      <mat-card class="info-card replenishment-method-card">
        <mat-card-header>
          <mat-icon class="card-icon" aria-hidden="true">local_shipping</mat-icon>
          <mat-card-title>Replenishment Method</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <p class="method-intro">
            Recommended method based on stock availability:
          </p>

          <mat-radio-group
            [(ngModel)]="selectedMethod"
            (change)="onMethodChange($event.value)"
            class="method-radio-group">

            @for (h of allHorizons; track h) {
              <div class="method-option"
                [class.selected]="selectedMethod === h">
                <mat-radio-button [value]="h">
                  <div class="method-content">
                    <span class="method-name">{{ methodMeta[h].label }}</span>
                    <span class="method-sublabel">({{ methodMeta[h].sublabel }})</span>
                    @if (recommendedMethod === h) {
                      <span class="badge recommended">Recommended</span>
                    }
                    @if (methodMeta[h].inDmis) {
                      <span class="badge in-dmis">In DMIS</span>
                    }
                    @if (!methodMeta[h].inDmis) {
                      <span class="badge external">External</span>
                    }
                  </div>
                  <div class="method-details">
                    {{ getMethodItemCount(h) }} &middot; Estimated: {{ methodMeta[h].timeframe }}
                  </div>
                </mat-radio-button>
              </div>
            }
          </mat-radio-group>
        </mat-card-content>
      </mat-card>

      <!-- Approval Info -->
      <mat-card class="info-card approval-card">
        <mat-card-header>
          <div class="approval-header"
            role="button"
            tabindex="0"
            [attr.aria-expanded]="showApprovalDetails"
            aria-controls="approval-details"
            (click)="toggleApprovalDetails()"
            (keydown.enter)="toggleApprovalDetails()"
            (keydown.space)="toggleApprovalDetails(); $event.preventDefault()">
            <div class="header-left">
              <mat-icon class="card-icon" aria-hidden="true">approval</mat-icon>
              <mat-card-title>Approval Required</mat-card-title>
            </div>
            <mat-icon class="expand-icon">{{ showApprovalDetails ? 'expand_less' : 'expand_more' }}</mat-icon>
          </div>
        </mat-card-header>
        <mat-card-content>
          <!-- Summary when collapsed -->
          @if (!showApprovalDetails && approvalWorkflows.length > 0) {
            <div class="approval-summary">
              <p>This needs list requires approval for:
                @for (wf of approvalWorkflows; track wf; let last = $last) {
                  <span>
                    <strong>{{ wf.config.name }}</strong>@if (!last) {
                    <span>, </span>
                  }
                </span>
              }
            </p>
          </div>
        }

        <!-- Detailed view when expanded -->
        @if (showApprovalDetails) {
          <div class="approval-details" id="approval-details">
            @if (approvalWorkflows.length > 1) {
              <p class="intro-text">
                This needs list contains items requiring different approval workflows:
              </p>
            }
            @for (workflow of activeApprovalWorkflows; track workflow) {
              <div class="workflow-section"
                [class.external]="!workflow.config.inDmis"
                [ngClass]="'horizon-' + workflow.horizon">
                <div class="workflow-header">
                  <mat-icon [ngClass]="'horizon-icon-' + workflow.horizon">{{ workflow.config.icon }}</mat-icon>
                  <span class="workflow-name">{{ workflow.config.name | uppercase }}</span>
                  <span class="workflow-stats">({{ workflow.itemCount }} items, {{ workflow.totalUnits | number }} units)</span>
                  <span class="workflow-badge" [class.external]="!workflow.config.inDmis">
                    <mat-icon>{{ workflow.config.inDmis ? 'check_circle' : 'open_in_new' }}</mat-icon>
                    {{ workflow.config.inDmis ? 'In DMIS' : 'External' }}
                  </span>
                </div>
                <div class="approval-steps">
                  @for (step of workflow.config.steps; track step) {
                    <div class="step"
                      [ngClass]="step.type">
                      <div class="step-indicator">
                        <span class="step-label">
                          @switch (step.type) {
                            @case ('primary') {
                              Step {{ step.step }}
                            }
                            @case ('escalation') {
                              Step {{ step.step }} (Escalation)
                            }
                            @case ('conditional') {
                              Step {{ step.step }} (If needed)
                            }
                            @case ('final') {
                              Step {{ step.step }} (Final)
                            }
                            @default {
                              Step {{ step.step }}
                            }
                          }
                        </span>
                      </div>
                      <div class="step-content">
                        <div class="step-role">
                          <mat-icon>person</mat-icon>
                          <span>{{ step.role }}</span>
                          @if (step.alternateRole) {
                            <span class="alternate"> or {{ step.alternateRole }}</span>
                          }
                        </div>
                        <div class="step-description">{{ step.description }}</div>
                        @if (step.external) {
                          <div class="external-indicator">
                            <mat-icon>open_in_new</mat-icon>
                            <span>External to DMIS</span>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
                @if (workflow.config.externalNote) {
                  <div class="external-note">
                    <mat-icon>info</mat-icon>
                    <span>{{ workflow.config.externalNote }}</span>
                  </div>
                }
              </div>
            }
            <!-- Empty state -->
            @if (activeApprovalWorkflows.length === 0) {
              <div class="no-workflows">
                <mat-icon>info</mat-icon>
                <span>No items selected for approval</span>
              </div>
            }
          </div>
        }

        @if (approvalWorkflows.length > 0) {
          <div class="notification-footer">
            <mat-icon>email</mat-icon>
            <span>Approvers will be notified via email and in-app notification.</span>
          </div>
        }
      </mat-card-content>
    </mat-card>

    <!-- Notes -->
    <mat-card class="notes-card">
      <mat-card-header>
        <mat-icon class="card-icon" aria-hidden="true">notes</mat-icon>
        <mat-card-title>Additional Notes</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="notesForm">
          <mat-form-field appearance="outline" class="notes-field">
            <mat-label>Notes (Optional)</mat-label>
            <textarea
              matInput
              formControlName="notes"
              rows="4"
              placeholder="Add any additional context, special instructions, or comments for the approver..."
            ></textarea>
            <mat-hint>These notes will be included with the needs list submission</mat-hint>
          </mat-form-field>
        </form>
      </mat-card-content>
    </mat-card>
  </div>
</div>

<!-- Errors -->
<div class="errors-container" role="alert" aria-live="assertive">
  <mat-card class="error-card" [hidden]="!errors.length">
    <mat-icon class="error-icon" aria-hidden="true">error</mat-icon>
    <div class="error-list">
      @for (err of errors; track $index) {
        <div class="error-item">{{ err }}</div>
      }
    </div>
  </mat-card>
</div>

<!-- Submission Overlay -->
<div class="submission-overlay" [hidden]="!submitting" role="alert" aria-live="assertive">
  <mat-progress-spinner diameter="48" mode="indeterminate" aria-label="Submitting needs list"></mat-progress-spinner>
  <span class="submission-text">Submitting needs list for approval...</span>
</div>

<!-- Actions -->
<mat-card class="actions-card">
  <mat-card-content>
    <div class="step-actions">
      <button mat-button (click)="goBack()" class="back-btn" [disabled]="submitting || savingDraft">
        <mat-icon>arrow_back</mat-icon>
        Back
      </button>

      <div class="primary-actions">
        <button
          matButton="outlined"
          color="accent"
          (click)="saveDraft()"
          [disabled]="submitting || savingDraft || totalItems === 0"
          class="draft-btn"
          >
          @if (savingDraft) {
            <mat-progress-spinner
              diameter="18"
              mode="indeterminate"
              class="btn-spinner"
              aria-label="Saving draft"
            ></mat-progress-spinner>
          }
          @if (!savingDraft) {
            <mat-icon>save</mat-icon>
          }
          @if (!savingDraft) {
            <span>Save as Draft</span>
          }
          @if (savingDraft) {
            <span>Saving...</span>
          }
        </button>
        <button
          mat-raised-button
          color="primary"
          (click)="submitForApproval()"
          [disabled]="submitting || savingDraft || totalItems === 0"
          class="submit-btn"
          >
          @if (submitting) {
            <mat-progress-spinner
              diameter="18"
              mode="indeterminate"
              class="btn-spinner"
              aria-label="Submitting"
            ></mat-progress-spinner>
          }
          @if (!submitting) {
            <mat-icon>send</mat-icon>
          }
          @if (!submitting) {
            <span>Submit for Approval</span>
          }
          @if (submitting) {
            <span>Submitting...</span>
          }
        </button>
      </div>
    </div>
  </mat-card-content>
</mat-card>
</div>

