<div class="tracker-page">
  <!-- Page Header -->
  <div class="page-header">
    <button mat-icon-button class="back-btn" type="button" aria-label="Back to submissions" (click)="backToSubmissions()">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <div class="header-text">
      <h1>{{ pageTitle() }}</h1>
      <p class="subtitle">
        @if (needsList(); as list) {
          {{ list.needs_list_no ?? 'N/A' }}
          <span class="separator">-</span>
        }
        {{ pageSubtitle() }}
      </p>
    </div>
    <button mat-stroked-button type="button" class="refresh-btn" (click)="refreshData()">
      <mat-icon>refresh</mat-icon>
      Refresh
    </button>
  </div>

  <!-- Offline banner -->
  @if (isOffline()) {
    <div class="banner banner-warning" role="status">
      <mat-icon aria-hidden="true">wifi_off</mat-icon>
      <span>Offline - showing last synced data.</span>
    </div>
  }

  <!-- Stale data banner -->
  @if (isStale()) {
    <div class="banner banner-info" role="status">
      <mat-icon aria-hidden="true">update</mat-icon>
      <span>Data has changed since you last loaded. Refresh to see updates.</span>
      <button mat-stroked-button type="button" (click)="refreshData()">Refresh</button>
    </div>
  }

  <!-- Loading skeleton -->
  @if (loading()) {
    <dmis-skeleton-loader variant="summary-card" [count]="3"></dmis-skeleton-loader>
  }

  <!-- Error state -->
  @if (!loading() && error()) {
    <dmis-empty-state
      icon="error_outline"
      title="Unable to load fulfillment details"
      message="There was an error loading this needs list. Please try again."
      actionLabel="Retry"
      actionIcon="refresh"
      (action)="refreshData()">
    </dmis-empty-state>
  }

  <!-- Main content -->
  @if (!loading() && !error() && needsList(); as list) {
    <!-- Superseded alert -->
    @if (mode() === 'superseded') {
      <div class="superseded-banner" role="alert">
        <mat-icon aria-hidden="true">info</mat-icon>
        <div class="superseded-content">
          <strong>This needs list has been superseded</strong>
          <span>A newer version has replaced this draft. The data below is read-only.</span>
        </div>
        @if (list.superseded_by_needs_list_id) {
          <button mat-flat-button color="primary" type="button" (click)="goToReplacement()">
            <mat-icon>open_in_new</mat-icon>
            Open Replacement
          </button>
        }
      </div>
    }

    <!-- Summary card -->
    <div class="summary-section">
      <div class="summary-stat">
        <mat-icon aria-hidden="true">assignment</mat-icon>
        <div class="stat-text">
          <span class="stat-label">Status</span>
          <span class="stat-value status-value" [attr.data-status]="list.status">{{ statusLabel() }}</span>
        </div>
      </div>
      <div class="summary-stat stat-coverage" [attr.data-coverage]="coverageLevel()">
        <mat-icon aria-hidden="true">pie_chart</mat-icon>
        <div class="stat-text">
          <span class="stat-label">Overall Coverage</span>
          <span class="stat-value">{{ totalCoverage() }}%</span>
        </div>
      </div>
      <div class="summary-stat">
        <mat-icon aria-hidden="true">inventory_2</mat-icon>
        <div class="stat-text">
          <span class="stat-label">Line Items</span>
          <span class="stat-value">{{ lines().length }}</span>
        </div>
      </div>
      <div class="summary-stat">
        <mat-icon aria-hidden="true">schedule</mat-icon>
        <div class="stat-text">
          <span class="stat-label">Last Synced</span>
          <span class="stat-value">{{ lastSyncedAt() ? (lastSyncedAt() | date:'mediumTime') : 'N/A' }}</span>
        </div>
      </div>
    </div>

    <!-- Execution Actions Panel -->
    @if (showExecutionActions()) {
      <div class="execution-actions">
        <span class="section-label">Execution Actions</span>
        <div class="actions-grid">
          @if (hasHorizonA()) {
            <div class="action-card action-card-a">
              <div class="action-card-header">
                <mat-icon aria-hidden="true">local_shipping</mat-icon>
                <div>
                  <span class="action-card-title">Transfers</span>
                  <span class="action-card-count">{{ horizonACount() }} items</span>
                </div>
              </div>
              <p class="action-card-desc">Draft inter-warehouse transfers for Horizon A items</p>
              <button mat-flat-button color="primary" type="button" (click)="navigateToTransfers()">
                <mat-icon>edit_note</mat-icon>
                Draft Transfers
              </button>
            </div>
          }
          @if (hasHorizonB()) {
            <div class="action-card action-card-b">
              <div class="action-card-header">
                <mat-icon aria-hidden="true">volunteer_activism</mat-icon>
                <div>
                  <span class="action-card-title">Donations</span>
                  <span class="action-card-count">{{ horizonBCount() }} items</span>
                </div>
              </div>
              <p class="action-card-desc">Allocate available donations or export needs for NGOs</p>
              <div class="action-card-buttons">
                <button mat-flat-button color="primary" type="button" (click)="navigateToDonations()">
                  <mat-icon>assignment</mat-icon>
                  Allocate Donations
                </button>
                <button mat-stroked-button type="button" (click)="exportDonationNeeds()">
                  <mat-icon>download</mat-icon>
                  Export Needs
                </button>
              </div>
            </div>
          }
          @if (hasHorizonC()) {
            <div class="action-card action-card-c">
              <div class="action-card-header">
                <mat-icon aria-hidden="true">shopping_cart</mat-icon>
                <div>
                  <span class="action-card-title">Procurement</span>
                  <span class="action-card-count">{{ horizonCCount() }} items</span>
                </div>
              </div>
              <p class="action-card-desc">Create and manage procurement orders for items that cannot be sourced internally</p>
              <div class="action-card-buttons">
                <button mat-flat-button color="primary" type="button" (click)="navigateToProcurement()">
                  <mat-icon>shopping_cart</mat-icon>
                  Manage Procurement
                </button>
                <button mat-stroked-button type="button" (click)="exportProcurementNeeds()">
                  <mat-icon>download</mat-icon>
                  Export CSV
                </button>
              </div>
            </div>
          }
        </div>
      </div>
    }

    <!-- Approval Success Overlay -->
    @if (showApprovalSuccess()) {
      <div
        class="approval-overlay"
        tabindex="0"
        role="button"
        aria-label="Dismiss approval dialog"
        (click)="dismissApprovalSuccessOnBackdrop($event)"
        (keydown.enter)="dismissApprovalSuccess()"
        (keydown.space)="$event.preventDefault(); dismissApprovalSuccess()">
        <div class="approval-dialog">
          <div class="approval-check">
            <mat-icon aria-hidden="true">check</mat-icon>
          </div>
          <h2 class="approval-title">Approved</h2>
          <p class="approval-message">
            This needs list has been approved and is now ready for fulfillment execution.
          </p>
          <button mat-flat-button color="primary" class="approval-ok-btn" type="button" (click)="dismissApprovalSuccess()">
            OK
          </button>
        </div>
      </div>
    }

    <!-- Line items -->
    @if (lines().length === 0) {
      <dmis-empty-state
        icon="inventory_2"
        title="No line items"
        message="This needs list does not have any fulfillment line items recorded.">
      </dmis-empty-state>
    } @else {
      <div class="lines-section">
        <span class="section-label">Line Items</span>

        <!-- Desktop compact table -->
        <div class="lines-table-wrap desktop-only">
          <table class="lines-table">
            <thead>
              <tr>
                <th class="col-expand"></th>
                <th class="col-item">Item</th>
                <th class="col-horizon">Source</th>
                <th class="col-num">Required</th>
                <th class="col-num">Covered</th>
                <th class="col-num">Remaining</th>
                <th class="col-coverage">Coverage</th>
              </tr>
            </thead>
            <tbody>
              @for (line of lines(); track line.id) {
                <!-- Main row -->
                <tr
                  class="line-row"
                  [class.row-expanded]="isLineExpanded(line.id)"
                  [class.row-fully-covered]="line.is_fully_covered"
                  [attr.aria-expanded]="isLineExpanded(line.id)"
                  tabindex="0"
                  (click)="toggleLineExpanded(line.id)"
                  (keydown.enter)="toggleLineExpanded(line.id)"
                  (keydown.space)="$event.preventDefault(); toggleLineExpanded(line.id)">
                  <td class="col-expand">
                    <mat-icon class="expand-icon" [class.rotated]="isLineExpanded(line.id)">expand_more</mat-icon>
                  </td>
                  <td class="col-item">
                    <span class="item-name">{{ line.item.name }}</span>
                    <span class="item-uom">{{ line.item.uom }}</span>
                  </td>
                  <td class="col-horizon">
                    <span class="horizon-chip" [attr.data-horizon]="line.horizon">
                      {{ getHorizonLabel(line.horizon) }}
                    </span>
                  </td>
                  <td class="col-num">{{ line.original_qty | number:'1.0-0' }}</td>
                  <td class="col-num covered-text">{{ line.covered_qty | number:'1.0-0' }}</td>
                  <td class="col-num remaining-text">{{ line.remaining_qty | number:'1.0-0' }}</td>
                  <td class="col-coverage">
                    <div class="coverage-cell">
                      <div class="coverage-bar-bg">
                        <div class="coverage-bar-fill" [style.width.%]="getCoveragePercent(line)" [attr.data-level]="getCoverageLevel(getCoveragePercent(line))"></div>
                      </div>
                      <span class="coverage-pct" [attr.data-level]="getCoverageLevel(getCoveragePercent(line))">{{ getCoveragePercent(line) }}%</span>
                    </div>
                  </td>
                </tr>

                <!-- Expanded detail row -->
                @if (isLineExpanded(line.id)) {
                  <tr class="detail-row">
                    <td colspan="7">
                      <div class="detail-content">
                        @if (line.fulfillment_sources.length > 0) {
                          <span class="detail-label">Fulfillment Sources</span>
                          <table class="sources-table">
                            <thead>
                              <tr>
                                <th>Type</th>
                                <th>Reference</th>
                                <th>Qty</th>
                                <th>Status</th>
                                <th>Date</th>
                              </tr>
                            </thead>
                            <tbody>
                              @for (source of line.fulfillment_sources; track source.source_type + '-' + source.source_reference + '-' + source.quantity) {
                                <tr>
                                  <td>
                                    <span class="source-type">
                                      <mat-icon aria-hidden="true" class="source-icon">{{ getSourceIcon(source.source_type, line.horizon) }}</mat-icon>
                                      {{ getSourceDisplayType(source.source_type, line.horizon) }}
                                    </span>
                                  </td>
                                  <td class="source-ref">{{ source.source_reference || 'N/A' }}</td>
                                  <td class="source-qty">{{ source.quantity | number:'1.0-0' }}</td>
                                  <td>
                                    <span class="source-status" [attr.data-status]="source.status">{{ getStatusLabel(source.status, source.source_type) }}</span>
                                  </td>
                                  <td class="source-date">{{ source.date ? (source.date | date:'short') : 'Pending' }}</td>
                                </tr>
                              }
                            </tbody>
                          </table>
                        } @else {
                          <p class="no-sources">No fulfillment sources recorded yet.</p>
                        }
                      </div>
                    </td>
                  </tr>
                }
              }
            </tbody>
          </table>
        </div>

        <!-- Mobile card list -->
        <div class="lines-mobile mobile-only">
          @for (line of lines(); track line.id) {
            <div class="mobile-line-card"
              [class.mobile-fully-covered]="line.is_fully_covered"
              [class.mobile-card-expanded]="isLineExpanded(line.id)"
              [attr.aria-expanded]="isLineExpanded(line.id)"
              tabindex="0"
              (click)="onMobileLineCardClick(line.id, $event)"
              (keydown.enter)="toggleLineExpanded(line.id)"
              (keydown.space)="$event.preventDefault(); toggleLineExpanded(line.id)">
              <div class="mobile-line-header">
                <div class="mobile-line-info">
                  <span class="item-name">{{ line.item.name }}</span>
                  <span class="item-uom">{{ line.item.uom }}</span>
                </div>
                <span class="horizon-chip" [attr.data-horizon]="line.horizon">{{ getHorizonLabel(line.horizon) }}</span>
              </div>
              <div class="mobile-line-stats">
                <span>{{ line.covered_qty | number:'1.0-0' }} / {{ line.original_qty | number:'1.0-0' }}</span>
                <span class="coverage-pct" [attr.data-level]="getCoverageLevel(getCoveragePercent(line))">{{ getCoveragePercent(line) }}%</span>
              </div>
              <mat-progress-bar mode="determinate" [value]="getCoveragePercent(line)"></mat-progress-bar>

              @if (isLineExpanded(line.id)) {
                <div class="mobile-line-detail">
                  @if (line.fulfillment_sources.length > 0) {
                    @for (source of line.fulfillment_sources; track source.source_type + '-' + source.source_reference + '-' + source.quantity) {
                      <div class="source-card">
                        <div class="source-card-header">
                          <span class="source-type">
                            <mat-icon aria-hidden="true" class="source-icon">{{ getSourceIcon(source.source_type, line.horizon) }}</mat-icon>
                            {{ getSourceDisplayType(source.source_type, line.horizon) }}
                          </span>
                          <span class="source-status" [attr.data-status]="source.status">{{ getStatusLabel(source.status, source.source_type) }}</span>
                        </div>
                        <div class="source-card-body">
                          <div class="source-field">
                            <span class="field-label">Reference</span>
                            <span>{{ source.source_reference || 'N/A' }}</span>
                          </div>
                          <div class="source-field">
                            <span class="field-label">Quantity</span>
                            <span>{{ source.quantity | number:'1.0-2' }}</span>
                          </div>
                          <div class="source-field">
                            <span class="field-label">Date</span>
                            <span>{{ source.date ? (source.date | date:'short') : 'Pending' }}</span>
                          </div>
                        </div>
                      </div>
                    }
                  } @else {
                    <p class="no-sources">No fulfillment sources recorded yet.</p>
                  }
                </div>
              }
            </div>
          }
        </div>
      </div>
    }
  }
</div>
