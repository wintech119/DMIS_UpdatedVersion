Fix the following issues. The issues can be from different files or can overlap on same lines in one file.

- In @backend/replenishment/services/data_access.py around lines 174 - 175, The loop converting DB results to ints may raise TypeError when category_id is NULL; update the code that iterates "for item_id, category_id in cursor.fetchall()" to either (a) change the SQL to exclude NULLs (add "WHERE category_id IS NOT NULL") or (b) add a null check in the loop before casting—e.g. skip or set categories[int(item_id)] = None when category_id is None, otherwise do categories[int(item_id)] = int(category_id); adjust whichever behavior fits business logic.

- In @docs/attached_assets/DMIS_DATABASE_SCHEMA_2025-12-03_1525.sql around lines 67 - 74, The trigger function public.set_updated_at updates NEW.update_dtime but agency_account_request uses column updated_at, so trg_aar_set_updated_at will fail; fix by either renaming the agency_account_request column updated_at → update_dtime or create a new trigger function (e.g., public.set_updated_at_v2) that sets NEW.updated_at := CURRENT_TIMESTAMP and update the trigger trg_aar_set_updated_at to execute that new function for table public.agency_account_request.

- In @docs/attached_assets/DMIS_DATABASE_SCHEMA_2025-12-03_1525.sql around lines 1919 - 1929, The user table defines two confusing columns: username (varchar(60), nullable, has unique index) and user_name (varchar(20), NOT NULL, no uniqueness) — consolidate them: decide whether a single login column (recommended name: username or login_name) or two distinct columns (login_name vs display_name) is intended, then ALTER TABLE user to migrate data (COPY user_name -> username or vice versa), update all foreign keys/code references to the chosen column, set the proper NOT NULL and length constraints on the retained column, add or move the unique index to the login column, and DROP the obsolete column (or rename columns for clarity) so only the intended column(s) remain; ensure you also update any index definitions and application code that reference username or user_name.

- In @docs/attached_assets/DMIS_DATABASE_SCHEMA_2025-12-03_1525.sql at line 5, The file contains a hardcoded secret in the \restrict and \unrestrict commands (the token string present at the shown line and again at line 4082); remove the literal token from the SQL schema and replace it with a placeholder or reference (e.g., use a template variable or SQL variable) so the deployment process injects the real value from environment variables or a secrets manager, update any deployment scripts to read the secret from the secret store and substitute into the SQL at runtime (referencing the \restrict and \unrestrict commands), and after fixing the file remove the secret from VCS history using git filter-repo/BFG or an equivalent tool and ensure the secret is stored in a proper secret manager rather than in the repo.

- In @docs/attached_assets/DMIS_DATABASE_SCHEMA_2025-12-03_1525.sql around lines 959 - 961, There are two identical CHECK constraints on donor.donor_name (c_donor_2 and donor_donor_name_check); remove one of them to avoid duplication—locate the constraint definitions where CONSTRAINT c_donor_2 CHECK (((donor_name)::text = upper((donor_name)::text))) and CONSTRAINT donor_donor_name_check CHECK (((donor_name)::text = upper((donor_name)::text))) are declared and delete either c_donor_2 or donor_donor_name_check so only a single CHECK on donor_name remains, ensuring any dependent references (if any) are updated accordingly.

- In @docs/deploy/nginx.conf.example around lines 210 - 214, The nginx example forwards several security headers via proxy_pass_header including Strict-Transport-Security which can cause duplicate HSTS headers because the server block also sets Strict-Transport-Security with "always"; to fix, decide which side should own HSTS and either remove the server block's Strict-Transport-Security setting or remove/omit the proxy_pass_header Strict-Transport-Security directive so NGINX won't pass an upstream HSTS header through (locate the proxy_pass_header lines and the server block that sets Strict-Transport-Security to make the change).

- In @docs/deploy/nginx.conf.example around lines 131 - 135, In the location /health block the add_header is placed after return so it never runs; move the add_header Content-Type text/plain directive (or set default_type text/plain) above the return statement in the location /health block so the header is emitted, or alternatively return the response with an explicit header via appropriate nginx syntax; update the location /health block (the "location /health" stanza) accordingly.

- In @docs/deploy/nginx.conf.example around lines 164 - 171, The current location block for "/replenishment/needs-list-preview/" uses alias with try_files falling back to an absolute URI which can re-enter the same location; change to use a named internal location for the SPA fallback: keep the existing location ^~ /replenishment/needs-list-preview/ and its alias, but replace the try_files fallback path with an internal named location token (e.g. @needs_list_preview_fallback) that serves the index.html (ensuring that the named location uses the correct alias/root to the same /var/www/dmis/spa/), and add a new named location block @needs_list_preview_fallback to return the index file so the internal redirect does not re-enter the same location.

- In @docs/deploy/nginx.conf.example around lines 160 - 171, The ^~ location block "location ^~ /replenishment/needs-list-preview/" bypasses regex-based sensitive-file blocks, so update that block to explicitly deny access to sensitive dotfiles and directories (e.g., .env, .git, .htaccess) by adding a URI check that returns 403 for requests matching hidden files or .git paths (use $uri or $request_uri pattern matching inside the "location ^~ /replenishment/needs-list-preview/" block to detect (^|/)\.(env|git|htaccess) and return 403). Ensure the deny/return rule is placed inside the existing SPA location block so those sensitive resources are never served.# =============================================================================
# DMIS NGINX Production Configuration Template
# =============================================================================
# This configuration template is designed for production deployment of DMIS
# behind NGINX as a reverse proxy.
#
# Prerequisites:
# - NGINX 1.18+ installed
# - SSL/TLS certificates obtained (Let's Encrypt recommended)
# - DMIS running via Gunicorn on internal port (e.g., 127.0.0.1:8000)
#
# Installation:
# 1. Copy this file to /etc/nginx/sites-available/dmis
# 2. Update server_name, ssl_certificate paths, and upstream address
# 3. Create symlink: ln -s /etc/nginx/sites-available/dmis /etc/nginx/sites-enabled/
# 4. Test config: nginx -t
# 5. Reload: systemctl reload nginx
#
# Security Notes:
# - This config complements DMIS's built-in CSP headers (does not override)
# - HSTS is enabled with a 1-year max-age
# - TLS 1.2+ only, modern cipher suites
# =============================================================================

# Upstream definition for Gunicorn/WSGI server
upstream dmis_app {
    # Run DMIS with: gunicorn --bind 127.0.0.1:8000 --workers 4 wsgi:app
    server 127.0.0.1:8000 fail_timeout=0;
    
    # For multiple workers/servers (load balancing):
    # server 127.0.0.1:8001 fail_timeout=0;
    # server 127.0.0.1:8002 fail_timeout=0;
    
    keepalive 32;
}

# Redirect HTTP to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name dmis.example.gov.jm;  # UPDATE: Your domain
    
    # Allow ACME challenge for Let's Encrypt certificate renewal
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    
    # Redirect all other HTTP requests to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# Main HTTPS server block
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name dmis.example.gov.jm;  # UPDATE: Your domain
    
    # ---------------------------------------------------------------------------
    # SSL/TLS Configuration
    # ---------------------------------------------------------------------------
    
    # Certificate paths (Let's Encrypt recommended)
    ssl_certificate /etc/letsencrypt/live/dmis.example.gov.jm/fullchain.pem;  # UPDATE
    ssl_certificate_key /etc/letsencrypt/live/dmis.example.gov.jm/privkey.pem;  # UPDATE
    
    # SSL session settings
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;
    
    # Modern TLS configuration (TLS 1.2+)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    # OCSP Stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/letsencrypt/live/dmis.example.gov.jm/chain.pem;  # UPDATE
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;
    
    # ---------------------------------------------------------------------------
    # Security Headers
    # ---------------------------------------------------------------------------
    # Note: DMIS application sets its own CSP, X-Frame-Options, and X-Content-Type-Options
    # These NGINX headers complement (not override) application headers
    
    # HSTS - Strict Transport Security (1 year, include subdomains)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    
    # Referrer Policy - Send origin only for cross-origin requests
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Permissions Policy - Restrict browser features
    add_header Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()" always;
    
    # ---------------------------------------------------------------------------
    # Request Limits
    # ---------------------------------------------------------------------------
    
    # Maximum upload size (matches DMIS MAX_CONTENT_LENGTH of 16MB)
    client_max_body_size 16M;
    
    # Request body buffer
    client_body_buffer_size 128k;
    
    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 120s;  # Allow time for report generation
    
    # Request rate limiting (define in http block: limit_req_zone $binary_remote_addr zone=dmis_limit:10m rate=10r/s;)
    # Uncomment if rate limiting is configured:
    # limit_req zone=dmis_limit burst=20 nodelay;
    
    # ---------------------------------------------------------------------------
    # Logging
    # ---------------------------------------------------------------------------
    
    access_log /var/log/nginx/dmis_access.log;
    error_log /var/log/nginx/dmis_error.log warn;
    
    # ---------------------------------------------------------------------------
    # Locations
    # ---------------------------------------------------------------------------
    
    # Health check endpoint (for load balancers)
    location /health {
        access_log off;
        return 200 "OK";
        add_header Content-Type text/plain;
    }
    
    # Static files - served directly by NGINX (bypasses Gunicorn)
    location /static/ {
        alias /var/www/dmis/static/;
        expires 7d;
        add_header Cache-Control "public, immutable";
        
        # Gzip compression for static assets
        gzip on;
        gzip_types text/css application/javascript application/json image/svg+xml;
        gzip_min_length 256;
    }
    
    # Uploaded files (if served directly)
    location /uploads/ {
        alias /var/www/dmis/uploads/;
        internal;  # Only accessible via X-Accel-Redirect from application
    }

    # -----------------------------------------------------------------------
    # Strangler slice: route ONLY the Needs List Preview SPA path
    # -----------------------------------------------------------------------
    # Assumes Angular build deployed to /var/www/dmis/spa with base-href:
    #   /replenishment/needs-list-preview/
    location = /replenishment/needs-list-preview {
        return 302 /replenishment/needs-list-preview/;
    }

    location ^~ /replenishment/needs-list-preview/ {
        alias /var/www/dmis/spa/;
        try_files $uri $uri/ /replenishment/needs-list-preview/index.html;
        add_header Cache-Control "no-cache";
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()" always;
    }
    
    # Block access to sensitive files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    location ~ \.(py|pyc|pyo|cfg|ini|sql|md|yml|yaml|sh|env)$ {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Main application proxy
    location / {
        proxy_pass http://dmis_app;
        
        # Preserve client IP for logging and security
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        # Host header for Flask url_for()
        proxy_set_header Host $http_host;
        
        # WebSocket support (if needed in future)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Buffer settings
        proxy_buffering on;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
        
        # Don't override application security headers
        proxy_pass_header X-Frame-Options;
        proxy_pass_header X-Content-Type-Options;
        proxy_pass_header Content-Security-Policy;
        proxy_pass_header Strict-Transport-Security;
    }
}

# =============================================================================
# HTTP Block Configuration (add to /etc/nginx/nginx.conf if not present)
# =============================================================================
# 
# http {
#     # Rate limiting zone
#     limit_req_zone $binary_remote_addr zone=dmis_limit:10m rate=10r/s;
#     
#     # Connection limits
#     limit_conn_zone $binary_remote_addr zone=dmis_conn:10m;
#     
#     # Hide NGINX version
#     server_tokens off;
#     
#     # Gzip settings
#     gzip on;
#     gzip_vary on;
#     gzip_proxied any;
#     gzip_comp_level 6;
#     gzip_types text/plain text/css text/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml;
# }
# =============================================================================
